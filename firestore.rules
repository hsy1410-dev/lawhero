rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ===============================
       ğŸ” ê³µí†µ í•¨ìˆ˜
       =============================== */
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return request.auth != null
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin";
    }

    /* ===============================
       ğŸ‘¤ ì‚¬ìš©ì ë°ì´í„°
       =============================== */
    match /users/{userId} {

      // ë³¸ì¸: read / write
      allow read, write: if isSignedIn() && request.auth.uid == userId;

      // ê´€ë¦¬ì: ëª¨ë“  ì‚¬ìš©ì read ê°€ëŠ¥
      allow read: if isAdmin();

      /* ---------- í”„ë¡œì íŠ¸ ---------- */
      match /projects/{projectId} {
        allow read, write: if isSignedIn() && request.auth.uid == userId;
      }

      /* ---------- ëŒ€í™” ---------- */
      match /conversations/{convId} {
        allow read, write: if isSignedIn() && request.auth.uid == userId;

        match /messages/{msgId} {
          allow read, write: if isSignedIn() && request.auth.uid == userId;
        }
      }
    }

    /* ===============================
       ğŸŒ ì „ì—­ ì ‘ê·¼ ì œì–´
       =============================== */
    match /system/globalAccess {

      // ë¡œê·¸ì¸í•œ ì‚¬ìš©ì: ìƒíƒœ ì¡°íšŒ
      allow read: if isSignedIn();

      // ê´€ë¦¬ìë§Œ ë³€ê²½ ê°€ëŠ¥
      allow write: if isAdmin();
    }

    /* ===============================
       ğŸ§¾ ê´€ë¦¬ì ë¡œê·¸
       =============================== */
    match /adminLogs/{logId} {

      // ê´€ë¦¬ìë§Œ ì¡°íšŒ
      allow read: if isAdmin();

      // ê´€ë¦¬ìë§Œ ìƒì„±
      allow create: if isAdmin();

      // ìˆ˜ì • / ì‚­ì œ ê¸ˆì§€
      allow update, delete: if false;
    }

    /* ===============================
       ğŸš« ê·¸ ì™¸ ì „ë¶€ ì°¨ë‹¨
       =============================== */
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

